<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CGI Public Safety Digital Maturity Assessment — Improved</title>
  <meta name="description" content="Interactive, accessible and exportable Public Safety Digital Maturity Assessment (improved UX, persistence, PDF export, analytics hooks)." />
  <!-- Chart.js & html2pdf CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{--bg:#f7f7fb;--card:#ffffff;--accent:#d61f69;--accent2:#5b2bd6;--muted:#6b7280;--text:#0f172a;--shadow:0 12px 30px rgba(2,6,23,0.08)}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0}
    .outer{padding:24px}
    .container{max-width:1100px;margin:0 auto}

    /* CGI gradient banner behind header */
    .brand-banner{background:linear-gradient(90deg,var(--accent),var(--accent2));padding:18px;border-radius:12px;color:white;margin-bottom:16px;box-shadow:var(--shadow)}
    .brand-banner .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand-title{font-size:1.15rem;font-weight:700}
    .brand-sub{opacity:0.92;font-size:0.95rem}

    /* Sticky top action bar */
    .sticky-actions{position:sticky;top:8px;z-index:1200;background:rgba(255,255,255,0.95);backdrop-filter:blur(4px);padding:8px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;gap:8px;align-items:center}
    .sticky-actions.hide{display:none}

    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:18px;margin-bottom:16px;transition:transform .18s ease,box-shadow .18s ease;opacity:0;transform:translateY(6px)}
    .card.show{opacity:1;transform:none}

    .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label.input{display:block;margin-bottom:6px;font-weight:600}
    select,input[type=text],input[type=email]{width:100%;padding:10px;border:1px solid #e6e7eb;border-radius:8px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;padding-top:12px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}

    .domain-title{font-weight:700;margin-bottom:8px}
    .question{margin-bottom:12px}
    .scale{display:flex;gap:8px;margin-top:6px}
    .scale button{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e7eb;background:#fff;cursor:pointer}
    .scale button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border-color:transparent}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;text-decoration:none;border:none;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
    .btn.alt{background:#111827}
    .btn.ghost{background:transparent;color:var(--muted)}
    .btn.small{padding:8px 10px;font-size:13px;border-radius:8px}
    .btn, .btn span { color: #fff !important }
    .btn.ghost, .btn.ghost span { color: var(--muted) !important }
    .domain-bar{display:flex;align-items:center;gap:8px;margin-top:8px}
    .domain-bar .label{width:160px;font-size:13px;color:var(--muted)}
    .domain-bar .barwrap{flex:1;background:#eef3f6;border-radius:999px;overflow:hidden;height:12px}
    .domain-bar .barfill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .6s cubic-bezier(.2,.9,.2,1)}

    .results-area{display:flex;flex-direction:column;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .radar-wrap{background:#fff;padding:12px;border-radius:10px}
    .progress{height:12px;background:#eef3f6;border-radius:999px;overflow:hidden;width:100%}
    .progress > .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .6s cubic-bezier(.2,.9,.2,1)}

    /* Animated circular progress */
    .progress-ring{width:56px;height:56px;position:relative}
    .progress-ring svg{transform:rotate(-90deg)}
    .progress-percent{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}

    .actions{display:flex;flex-direction:column;gap:10px}
    .actions .row{display:flex;gap:8px;flex-wrap:wrap}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    .note{font-size:13px;color:var(--muted)}

    /* subtle focus states */
    button:focus, select:focus, input:focus{outline:3px solid rgba(86,12,100,0.12);outline-offset:2px}

    /* micro animations */
    .fade-in-up{animation:fadeUp .5s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}

  </style>
</head>
<body>
  <div class="outer">
    <div class="container">

      <!-- Brand banner -->
      <div class="brand-banner">
        <div class="row">
          <div>
            <div class="brand-title">CGI Public Safety Digital Maturity Assessment</div>
            <div class="brand-sub">Fast, defensible digital maturity assessment for policing and allied organisations.</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <button class="btn small" id="headerCta"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 8h18M3 12h18M3 16h18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Book a briefing</span></button>
            <button class="btn small" id="fullRestartHeader" title="Full restart"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12a9 9 0 1 0-3 6.7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Full Restart</span></button>
          </div>
        </div>
      </div>

      <!-- Sticky actions (visible while scrolling) -->
      <div id="stickyActions" class="sticky-actions hide">
        <button class="btn small" id="stickyCalc"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg><span>Get my score</span></button>
        <button class="btn small alt" id="stickySave"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M5 5h14v14H5zM9 5v6h6V5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Save</span></button>
        <button class="btn small" id="stickyExport"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 3v12M8 7l4-4 4 4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Export PDF</span></button>
      </div>

      <div class="card" id="step-0">
        <div class="meta">
          <div style="flex:1;min-width:220px">
            <label class="input" for="orgType">Organisation type</label>
            <select id="orgType" aria-label="Organisation type">
              <option>Police Force</option>
              <option>Home Office Directorate</option>
              <option>Arm's-Length Body (ALB)</option>
              <option>PCC / Local Authority</option>
              <option>Other</option>
            </select>
          </div>
          <div style="width:260px;min-width:160px">
            <label class="input" for="role">Role</label>
            <select id="role" aria-label="Your role">
              <option>Director</option>
              <option>CIO / CDO</option>
              <option>Programme Lead</option>
              <option>Head of Data</option>
              <option>Operational Lead</option>
              <option>Other</option>
            </select>
          </div>
          <div style="width:260px;min-width:160px">
            <label class="input" for="email">Optional: email to receive full PDF</label>
            <input id="email" type="email" placeholder="name@organisation.gov.uk" aria-label="Email for PDF report" />
          </div>
        </div>
        <div style="margin-top:12px;text-align:right">
          <button class="btn" id="startBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3v18l15-9L5 3z" fill="white"/></svg><span style="margin-left:6px">Start Assessment</span></button>
        </div>
      </div>

      <div class="grid">
        <div class="card questions" id="assessment" aria-live="polite" style="display:none">
          <!-- Questions injected here -->
        </div>

        <aside class="card results-area" aria-labelledby="resultsHeading">
          <div>
            <h2 id="resultsHeading">Progress & Quick Actions</h2>
            <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
              <div class="progress" style="flex:1">
                <div class="bar" id="progressBar"></div>
              </div>
              <div class="progress-ring" aria-hidden="true" id="ringWrap">
                <svg width="56" height="56"><circle cx="28" cy="28" r="24" stroke="#e9edf0" stroke-width="6" fill="none"></circle><circle cx="28" cy="28" r="24" stroke="url(#grad)" stroke-width="6" fill="none" id="ringCircle" stroke-linecap="round" stroke-dasharray="150" stroke-dashoffset="150"></circle></svg>
                <div class="progress-percent" id="ringPercent">0%</div>
              </div>
            </div>
            <div class="note" id="progressText">Not started</div>
          </div>

          <div class="radar-wrap" style="margin-top:12px">
            <canvas id="radarChart" width="320" height="260" aria-label="Domain radar chart" role="img"></canvas>
          </div>

          <!-- Per-domain horizontal bars -->
          <div id="domainBars" style="margin-top:12px"></div>

          <div class="small" id="scoreSummary">Score: — / 120</div>

          <div class="actions" style="margin-top:10px">
            <div class="row">
              <button class="btn" id="calcBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg> <span style="margin-left:6px">Get my score</span></button>
              <button class="btn alt" id="saveBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 5h14v14H5zM9 5v6h6V5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> <span style="margin-left:6px">Save progress</span></button>
              <button class="btn small" id="loadBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M19 12l-7 7-7-7" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> <span style="margin-left:6px">Load</span></button>
              <button class="btn small" id="exportBtn" style="background:#0b74ff"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v12M8 7l4-4 4 4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> <span style="margin-left:6px">Export PDF</span></button>
              <button class="btn small" id="resetBtn" style="background:#b91c1c"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> <span style="margin-left:6px">Clear & Restart</span></button>
            </div>
          </div>

          <!-- Reset confirmation banner (hidden by default) -->
          <div id="resetBanner" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:#fff3f3;border:1px solid #f5c6cb">
            <div style="font-weight:700;margin-bottom:6px;color:#7f1d1d">Confirm reset</div>
            <div style="margin-bottom:8px;color:#7f1d1d">This will permanently clear your saved progress in this browser. The assessment will be reset to its initial state.</div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="confirmResetBtn" style="background:#7f1d1d">Yes, clear my answers</button>
              <button class="btn" id="cancelResetBtn" style="background:#6b7280">Cancel</button>
            </div>
          </div>

          <!-- Toast notification -->
          <div id="toast" role="status" aria-live="polite" style="display:none;position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(16,24,40,0.2)">Reset successful</div>

          <div style="margin-top:10px">
            <div class="small">Recommended next step:</div>
            <div id="recommended" style="font-weight:700;margin-top:6px">—</div>
          </div>

          <div style="margin-top:8px" class="note">This improved tool supports keyboard navigation, persistence (localStorage), client-side PDF export and polished UI transitions.</div>
        </aside>
      </div>

      <div id="resultsCard" style="display:none;margin-top:12px"></div>

      <!-- New user modal -->
      <div id="newUserModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1300">
        <div style="max-width:560px;margin:40px auto;background:white;border-radius:12px;padding:20px;box-shadow:0 12px 40px rgba(2,6,23,0.25)">
          <h3 style="margin-top:0">New user — start a fresh assessment</h3>
          <p class="small">Starting fresh will clear all saved progress and return you to the welcome screen to enter organisation details.</p>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" id="confirmNewUser" style="background:linear-gradient(90deg,var(--accent2),var(--accent))">Yes, start new</button>
            <button class="btn" id="cancelNewUser" style="background:#6b7280">Cancel</button>
          </div>
        </div>
      </div>

      <footer>
        <div class="small">Based on Jisc's Digital Maturity Model adapted for Public Safety. Reference PDF: /mnt/data/maturity_model_for_digital_transformation_in_HE.pdf</div>
      </footer>

    </div>
  </div>

  <script>
    // === Reference to the original uploaded file for traceability ===
    // Original: fileciteturn1file0

    // CONFIG
    const frameworkPdfPath = '/mnt/data/maturity_model_for_digital_transformation_in_HE.pdf';

    const domains = [
      { key:'culture', title:'Digital Culture, Strategy & Leadership', qs:[
        'Our organisation has a clear, shared digital strategy aligned to mission outcomes',
        'Senior leaders are confident and capable digital decision-makers',
        'We actively encourage innovation, experimentation, and safe-to-fail learning',
        'Change management and user adoption practices are well-structured and effective',
        'Digital services reflect equity, inclusion, accessibility and wellbeing considerations'
      ]},
      { key:'tech', title:'Technology, Architecture & Cyber Security', qs:[
        'Our technology estate is modern, integrated and cloud-ready',
        'Technical debt and legacy risks are actively managed and reducing',
        'We use consistent architectural patterns and standards across systems',
        'We have a mature cyber security posture and Zero Trust principles embedded',
        'Infrastructure is reliable, resilient and scalable for critical operations'
      ]},
      { key:'data', title:'Data, Information, Analytics & AI', qs:[
        'We have a clear data strategy with strong governance and accountable data ownership',
        'Our data is standardised, integrated and trusted across the organisation',
        'We have strong analytical and BI capabilities that support decision-making',
        'We are ready to adopt AI safely, ethically and transparently',
        'We can share information effectively across partners and agencies'
      ]},
      { key:'people', title:'People, Skills & Ways of Working', qs:[
        'We understand workforce digital skills and plan to meet future needs',
        'Digital skills training is accessible and effective for all staff',
        'Our operating model supports agile, cross-functional working',
        'We recruit and retain specialist digital, data and cyber talent effectively',
        'Staff feel confident, supported and empowered in using digital tools'
      ]},
      { key:'partners', title:'Partnerships, Ecosystem & Interoperability', qs:[
        'We align well with national standards and cross-agency frameworks',
        'We take a strategic approach to working with suppliers and delivery partners',
        'Our systems interoperate effectively across agencies and forces',
        'Digital services are co-designed with citizens, officers and frontline staff',
        'We uphold strong principles of digital ethics, transparency and trust'
      ]},
      { key:'infra', title:'Digital Infrastructure, Connectivity & Support', qs:[
        'Our networks are reliable, scalable and high-performing',
        'Staff have modern, secure tools that enable effective working',
        'Digital support is proactive, skilled and well-coordinated',
        'Technology is sustainable, well-managed and lifecycle-controlled',
        'Digital systems integrate well with physical estate, equipment and assets'
      ]}
    ];

    const recommendations = [
      {band:'Starting Out', min:0, max:40, title:'Legacy / Fragmented', cta:'Control Tower Assurance & Legacy Stabilisation Service'},
      {band:'Building the Basics', min:41, max:70, title:'Foundational (2027)', cta:'Police Digital Enablement Service (PDES) and Data Governance Setup'},
      {band:'Scaling & Integrating', min:71, max:95, title:'Integrated (2030)', cta:'Data Fabric / Interoperability Accelerator Programme'},
      {band:'Data-Driven & Predictive', min:96, max:110, title:'Intelligent (2033)', cta:'AI Governance, Digital Twins & Predictive Policing Toolkit'},
      {band:'2035 Ready', min:111, max:120, title:'Ecosystem Orchestrated', cta:'Ecosystem Stewardship & National Platforms Partnership'}
    ];

    // state
    let state = {meta:{}, answers:{}};

    // elements
    const startBtn = document.getElementById('startBtn');
    const assessmentEl = document.getElementById('assessment');
    const calcBtn = document.getElementById('calcBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const scoreSummary = document.getElementById('scoreSummary');
    const recommendedEl = document.getElementById('recommended');

    // extra elements for sticky
    const stickyActions = document.getElementById('stickyActions');
    const stickyCalc = document.getElementById('stickyCalc');
    const stickySave = document.getElementById('stickySave');
    const stickyExport = document.getElementById('stickyExport');

    startBtn.addEventListener('click', ()=>{
      state.meta.orgType = document.getElementById('orgType').value;
      state.meta.role = document.getElementById('role').value;
      state.meta.email = document.getElementById('email').value;
      document.getElementById('step-0').style.display='none';
      renderQuestions();
      assessmentEl.style.display='block';
      // attempt to load saved state automatically if present
      if(localStorage.getItem('psbm_assessment_auto')){
        try{ const s=JSON.parse(localStorage.getItem('psbm_assessment_auto')); if(s && s.answers) { state=s; applyStateToUI(); } }catch(e){}
      }
      // reveal cards with animation
      document.querySelectorAll('.card').forEach((c,i)=>{ setTimeout(()=>c.classList.add('show'), i*80); });
    });

    function renderQuestions(){
      assessmentEl.innerHTML='';
      domains.forEach((d,di)=>{
        const dom = document.createElement('section'); dom.className='card'; dom.setAttribute('aria-labelledby', `dom-${d.key}`);
        const title = document.createElement('h3'); title.id=`dom-${d.key}`; title.className='domain-title'; title.textContent = `${di+1}. ${d.title}`;
        dom.appendChild(title);
        d.qs.forEach((q,qi)=>{
          const qwrap = document.createElement('div'); qwrap.className='question'; qwrap.tabIndex=0;
          const qlabel = document.createElement('label'); qlabel.textContent = `${qi+1}. ${q}`; qwrap.appendChild(qlabel);
          const scale = document.createElement('div'); scale.className='scale';
          for(let s=0;s<=4;s++){
            const btn = document.createElement('button'); btn.type='button'; btn.innerHTML = `<span aria-hidden=\"true\">${s}</span><div style=\"font-size:12px;color:var(--muted)\">${labelForScore(s)}</div>`;
            btn.dataset.domain = d.key; btn.dataset.q = qi; btn.dataset.score = s;
            btn.setAttribute('aria-pressed','false');
            btn.addEventListener('click', onScoreClick);
            scale.appendChild(btn);
          }
          qwrap.appendChild(scale);
          dom.appendChild(qwrap);
        });
        assessmentEl.appendChild(dom);
      });
      updateProgress();
    }

    function labelForScore(s){switch(s){case 0:return 'Not started';case 1:return 'Emerging';case 2:return 'Established';case 3:return 'Enhanced';case 4:return 'Mature';}}

    function onScoreClick(e){
      const btn = e.currentTarget; const domain = btn.dataset.domain; const q = btn.dataset.q; const score = parseInt(btn.dataset.score,10);
      // set active class on siblings
      const siblings = btn.parentNode.querySelectorAll('button'); siblings.forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-pressed','false');});
      btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
      if(!state.answers[domain]) state.answers[domain] = {};
      state.answers[domain][q] = score;
      saveAuto();
      updateProgress();
    }

    function updateProgress(){
      // compute % answered
      const totalQs = domains.length * 5; let answered=0;
      domains.forEach(d=>{ d.qs.forEach((q,qi)=>{ if(state.answers[d.key] && typeof state.answers[d.key][qi] !== 'undefined') answered++; }); });
      const pct = Math.round((answered/totalQs)*100);
      progressBar.style.width = pct + '%';
      progressText.textContent = `${answered} / ${totalQs} questions answered (${pct}%)`;

      // animate circular ring
      const ring = document.getElementById('ringCircle');
      const ringPercent = document.getElementById('ringPercent');
      if(ring){
        const circumference = 2*Math.PI*24; // r=24
        const offset = Math.round(circumference*(1 - (pct/100)));
        ring.style.strokeDasharray = circumference;
        ring.style.transition = 'stroke-dashoffset 700ms cubic-bezier(.2,.9,.2,1)';
        ring.style.strokeDashoffset = offset;
        ringPercent.textContent = pct + '%';
      }

      // show sticky actions when scrolled past header (or when progress visible)
      const scrolled = window.scrollY > 160 || pct > 0;
      if(scrolled) stickyActions.classList.remove('hide'); else stickyActions.classList.add('hide');
    }

    function calculateScore(){
      // ensure defaults
      // ensure defaults
      domains.forEach(d=>{ if(!state.answers[d.key]) state.answers[d.key]={}; d.qs.forEach((q,qi)=>{ if(typeof state.answers[d.key][qi] === 'undefined') state.answers[d.key][qi] = 0; }); });
      const domainScores = domains.map(d=>{ const sum = Object.values(state.answers[d.key]).reduce((a,b)=>a+b,0); return {key:d.key,title:d.title,score:sum,max:d.qs.length*4}; });
      const total = domainScores.reduce((a,b)=>a+b.score,0);
      scoreSummary.textContent = `Score: ${total} / 120`;
      // recommendation
      const rec = recommendations.find(r=> total>=r.min && total<=r.max);
      recommendedEl.textContent = rec ? `${rec.title} — ${rec.cta}` : '—';
      // draw radar
      drawRadar(domainScores.map(d=>d.score));
      // render per-domain horizontal bars in the aside
      const domainBars = document.getElementById('domainBars'); if(domainBars){ domainBars.innerHTML=''; domainScores.forEach(ds=>{ const pct = Math.round((ds.score/ds.max)*100); const div = document.createElement('div'); div.className='domain-bar'; div.innerHTML = `<div class="label">${ds.title}</div><div class="barwrap"><div class="barfill" style="width:${pct}%"></div></div><div style="width:46px;text-align:right;font-weight:700">${ds.score}</div>`; domainBars.appendChild(div); }); }
      // show results card content
      renderResultCard(total,domainScores);
      // attach download behaviour
      return {total,domainScores,rec};
      // attach download behaviour
      return {total,domainScores,rec};
    }

    calcBtn.addEventListener('click', ()=>{
      const r = calculateScore();
      if(state.meta.email){
        alert('PDF export is available — use Export PDF. (Note: automatic emailing is not configured in this demo.)');
      }
    });

    function renderResultCard(total,domainScores){
      const rc = document.getElementById('resultsCard'); rc.innerHTML = '';
      const out = document.createElement('div'); out.className='card';
      out.innerHTML = `<h3>Detailed summary</h3><div class="small">Total score: ${total} / 120</div>`;
      domainScores.forEach(ds=>{
        const div = document.createElement('div'); div.style.marginTop='8px'; div.innerHTML = `<strong>${ds.title}</strong> — ${ds.score} / ${ds.max}<div class="progress" style="margin-top:6px"><div class="bar" style="width:${(ds.score/ds.max)*100}%"></div></div>`;
        out.appendChild(div);
      });
      rc.appendChild(out);
      rc.style.display='block';
    }

    function drawRadar(values){
      const canvas = document.getElementById('radarChart');
      const ctx = canvas.getContext('2d');
      if(window._radar) window._radar.destroy();
      // create gradient for Chart.js dataset
      const grad = ctx.createLinearGradient(0,0,canvas.width,0);
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#d61f69';
      const accent2 = getComputedStyle(document.documentElement).getPropertyValue('--accent2').trim() || '#5b2bd6';
      grad.addColorStop(0, accent);
      grad.addColorStop(1, accent2);
      window._radar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: domains.map(d=>d.title),
          datasets: [{ label: 'Domain score', data: values, backgroundColor: 'rgba(214,31,105,0.14)', borderColor: grad, borderWidth:2, pointBackgroundColor:accent}]
        },
        options: { scales: { r: { suggestedMin:0, suggestedMax:20, ticks:{stepSize:5} } }, plugins:{legend:{display:false}} }
      });
    }

    // Save/load to localStorage
    saveBtn.addEventListener('click', ()=>{ localStorage.setItem('psbm_assessment', JSON.stringify(state)); alert('Progress saved locally.'); });
    loadBtn.addEventListener('click', ()=>{ const s = localStorage.getItem('psbm_assessment'); if(s){ state=JSON.parse(s); applyStateToUI(); updateProgress(); alert('Progress loaded.'); } else alert('No saved progress found.'); });
    function saveAuto(){ localStorage.setItem('psbm_assessment_auto', JSON.stringify(state)); }

    function applyStateToUI(){
      // apply answers to UI scale buttons
      domains.forEach(d=>{
        d.qs.forEach((q,qi)=>{
          const val = state.answers[d.key] && typeof state.answers[d.key][qi] !== 'undefined' ? state.answers[d.key][qi] : null;
          if(val !== null){
            // find the question node
            const btn = document.querySelector(`button[data-domain='${d.key}'][data-q='${qi}'][data-score='${val}']`);
            if(btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
          }
        });
      });
      // update meta
      if(state.meta && state.meta.orgType) document.getElementById('orgType').value = state.meta.orgType;
      if(state.meta && state.meta.role) document.getElementById('role').value = state.meta.role;
      if(state.meta && state.meta.email) document.getElementById('email').value = state.meta.email;
    }

    // Export to PDF (client-side using html2pdf)
    exportBtn.addEventListener('click', async ()=>{
      const calc = calculateScore();
      // build a printable DOM fragment
      const printEl = document.createElement('div'); printEl.style.padding='20px'; printEl.style.fontFamily='Arial,Helvetica,sans-serif';
      printEl.innerHTML = `<h2>CGI Public Safety Digital Maturity Assessment — Report</h2><div style='margin-top:6px'>Organisation: ${state.meta.orgType || '—'} | Role: ${state.meta.role || '—'}</div><div style='margin-top:6px'>Score: ${calc.total} / 120</div>`;
      calc.domainScores.forEach(ds=>{ printEl.innerHTML += `<div style='margin-top:10px'><strong>${ds.title}</strong> — ${ds.score} / ${ds.max}</div>`; });
      printEl.innerHTML += `<div style='margin-top:12px'><strong>Recommended:</strong> ${calc.rec ? calc.rec.cta : '—'}</div>`;
      // include radar as image
      const canvas = document.getElementById('radarChart'); const dataUrl = canvas.toDataURL('image/png');
      printEl.innerHTML += `<div style='margin-top:12px'><img src='${dataUrl}' alt='radar chart' style='max-width:100%'/></div>`;
      // use html2pdf
      const opt = { margin:10, filename: 'CGI_Digital_Maturity_Report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:1, useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
      html2pdf().set(opt).from(printEl).save();
    });

    // Basic keyboard accessibility: allow arrow keys to change score when question focused
    document.addEventListener('keydown',(e)=>{
      const active = document.activeElement; if(!active) return;
      if(active.classList && active.classList.contains('question')){
        if(['ArrowRight','ArrowLeft'].includes(e.key)){
          const buttons = active.querySelectorAll('button'); if(!buttons.length) return;
          // find current index
          let idx=-1; buttons.forEach((b,i)=>{ if(b.classList.contains('active')) idx=i; });
          if(e.key==='ArrowRight' && idx < buttons.length-1) buttons[idx+1].click();
          if(e.key==='ArrowLeft' && idx > 0) buttons[idx-1].click();
        }
      }
    });

    // small helper to open the reference PDF in a new tab
    function openFrameworkPdf(){ window.open(frameworkPdfPath, '_blank'); }

    // header CTA behaviour
    const headerCta = document.getElementById('headerCta');
    if(headerCta){ headerCta.addEventListener('click', ()=>{ window.location.href = 'mailto:publicsafety@cgi.com?subject=Request%20for%20Digital%20Maturity%20Briefing'; }); }

    // sticky actions wiring
    if(stickyCalc) stickyCalc.addEventListener('click', ()=> calcBtn.click());
    if(stickySave) stickySave.addEventListener('click', ()=> saveBtn.click());
    if(stickyExport) stickyExport.addEventListener('click', ()=> exportBtn.click());

    // Full Restart in header: clear and reload to start from welcome card
    const fullRestartHeader = document.getElementById('fullRestartHeader');
    if(fullRestartHeader){ fullRestartHeader.addEventListener('click', ()=>{
      if(confirm('Restart the whole assessment from the very beginning?')){
        localStorage.removeItem('psbm_assessment');
        localStorage.removeItem('psbm_assessment_auto');
        location.reload();
      }
    }); }

    // New user modal behaviour
    const newUserBtn = document.getElementById('newUserBtn');
    const newUserModal = document.getElementById('newUserModal');
    const confirmNewUser = document.getElementById('confirmNewUser');
    const cancelNewUser = document.getElementById('cancelNewUser');
    if(newUserBtn){ newUserBtn.addEventListener('click', ()=>{ newUserModal.style.display='flex'; }); }
    if(cancelNewUser){ cancelNewUser.addEventListener('click', ()=>{ newUserModal.style.display='none'; }); }
    if(confirmNewUser){ confirmNewUser.addEventListener('click', ()=>{
      // perform full restart
      localStorage.removeItem('psbm_assessment');
      localStorage.removeItem('psbm_assessment_auto');
      location.reload();
    }); }

    // Reset/Clear functionality
    const resetBtn = document.getElementById('resetBtn');
    const resetBanner = document.getElementById('resetBanner');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    const cancelResetBtn = document.getElementById('cancelResetBtn');
    const toast = document.getElementById('toast');

    function softReset(){
      // clear stored data
      localStorage.removeItem('psbm_assessment');
      localStorage.removeItem('psbm_assessment_auto');
      // reset in-memory state
      state = {meta:{},answers:{}};
      // clear UI: remove active classes
      document.querySelectorAll('button.active').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      // clear meta inputs
      document.getElementById('orgType').value = 'Police Force';
      document.getElementById('role').value = 'Director';
      document.getElementById('email').value = '';
      // clear results area
      scoreSummary.textContent = 'Score: — / 120';
      recommendedEl.textContent = '—';
      document.getElementById('resultsCard').style.display='none';
      // destroy radar if exists
      if(window._radar) { try{ window._radar.destroy(); }catch(e){} }
      // update progress
      updateProgress();
      // hide banner
      resetBanner.style.display='none';
      // show toast
      toast.textContent = 'Reset successful'; toast.style.display='block';
      setTimeout(()=>{ toast.style.display='none'; },3000);
      // make questions visible again if hidden
      assessmentEl.style.display='block';
    }

    if(resetBtn){
      resetBtn.addEventListener('click', ()=>{
        // show banner instead of confirm()
        resetBanner.style.display = 'block';
        // scroll into view for small screens
        resetBanner.scrollIntoView({behavior:'smooth',block:'center'});
      });
    }
    if(cancelResetBtn){ cancelResetBtn.addEventListener('click', ()=>{ resetBanner.style.display='none'; }); }
    if(confirmResetBtn){ confirmResetBtn.addEventListener('click', ()=>{ softReset(); }); }

    // reveal sticky bar on scroll
    window.addEventListener('scroll', ()=>{
      const reveal = window.scrollY > 220;
      if(reveal) stickyActions.classList.remove('hide'); else stickyActions.classList.add('hide');
    });

    // small initial show of cards
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.card').forEach((c,i)=>{ setTimeout(()=>c.classList.add('show'), i*60); });
    });

    // expose simple analytics hook (no external tracking by default) — teams can hook into this
    window._psbm_analytics = function(event, payload){ console.log('PSBM analytics event', event, payload); /* insert tracking here */ };

    // End of script
  </script>
</body>
</html> 


